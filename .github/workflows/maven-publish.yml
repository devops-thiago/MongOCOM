name: Maven Central Publish

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Wait for MongoDB
      run: |
        echo "Waiting for MongoDB to be ready..."
        for i in {1..30}; do
          if mongosh --eval "db.adminCommand('ping')" --quiet; then
            echo "MongoDB is ready!"
            break
          fi
          echo "Waiting for MongoDB... ($i/30)"
          sleep 2
        done

    - name: Run tests
      run: mvn clean test

    - name: Run integration tests with examples
      run: |
        # Build the main library
        mvn clean install -DskipTests

        # Compile and run examples
        mkdir -p examples/target/classes

        # Find MongoDB driver JARs
        MONGODB_SYNC_JAR=$(find ~/.m2/repository -name "*mongodb-driver-sync*.jar" | head -1)
        MONGODB_BSON_JAR=$(find ~/.m2/repository -name "*bson*.jar" | grep mongodb | head -1)
        MONGODB_CORE_JAR=$(find ~/.m2/repository -name "*mongodb-driver-core*.jar" | head -1)

        CLASSPATH="target/mongocom-0.4-SNAPSHOT.jar:$MONGODB_SYNC_JAR:$MONGODB_BSON_JAR:$MONGODB_CORE_JAR"

        # Compile examples
        javac -cp "$CLASSPATH" \
          -d examples/target/classes \
          examples/src/com/example/collections/types/*.java \
          examples/src/com/example/collections/*.java \
          examples/src/com/example/main/*.java

        # Run example (with timeout to prevent hanging)
        timeout 30s java -cp "$CLASSPATH:examples/target/classes" com.example.main.Main || echo "Example completed or timed out"

  publish-snapshot:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Publish SNAPSHOT to Maven Central
      run: mvn clean deploy -DskipTests
      env:
        MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

  publish-release:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Extract version from tag
      id: extract_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Extracted version: $TAG_NAME"

    - name: Update version in pom.xml
      run: |
        mvn versions:set -DnewVersion=${{ steps.extract_version.outputs.VERSION }}
        mvn versions:commit

    - name: Publish RELEASE to Maven Central
      run: mvn clean deploy -DskipTests
      env:
        MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ steps.extract_version.outputs.VERSION }}
        body: |
          Release ${{ steps.extract_version.outputs.VERSION }} of MongOCOM

          ## Changes
          - Updated to version ${{ steps.extract_version.outputs.VERSION }}
          - Published to Maven Central

          ## Maven Dependency
          ```xml
          <dependency>
              <groupId>com.arquivolivre</groupId>
              <artifactId>mongocom</artifactId>
              <version>${{ steps.extract_version.outputs.VERSION }}</version>
          </dependency>
          ```
        draft: false
        prerelease: false

